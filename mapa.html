<!DOCTYPE html>
<html lang="pl">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Mapa Ładowarek Bez Przeglądu</title>
		<link rel="stylesheet" href="style/style.css" />
		<script
			src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
			crossorigin=""
		></script>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			crossorigin=""
		/>
	</head>
	<body>
		<h1>Mapa Ładowarek Bez Przeglądu</h1>
		<div id="map" style="width: 100%; height: 600px"></div>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				// Inicjalizacja mapy
				var map = L.map('map').setView([52.237049, 21.017532], 6); // Środek Polski

				// Dodanie warstwy mapy z OpenStreetMap
				L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution:
						'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
				}).addTo(map);

				// Pobranie danych o ładowarkach bez przeglądu
				fetch('api.php')
					.then((response) => response.json())
					.then((data) => {
						data.forEach((record) => {
							// Sprawdzenie czy ładowarka nie ma przeglądu na 2025 rok
							if (!record.przeglad_2025) {
								// Wyciągnięcie współrzędnych geograficznych z lokalizacji (miasto, ulica, nr)
								getCoordinatesFromLocation(record.lokalizacja)
									.then((coords) => {
										if (coords) {
											// Dodanie markera na mapie dla ładowarki bez przeglądu
											L.marker([coords.lat, coords.lon])
												.addTo(map)
												.bindPopup(
													`<b>${record.numer_seryjny}</b><br>${record.lokalizacja}`
												);
										}
									})
									.catch((error) =>
										console.error('Błąd przy pobieraniu współrzędnych:', error)
									);
							}
						});
					})
					.catch((error) =>
						console.error('Błąd przy pobieraniu danych:', error)
					);
			});

			// Funkcja do uzyskiwania współrzędnych na podstawie lokalizacji, korzysta z OpenStreetMap Nominatim API
			function getCoordinatesFromLocation(location) {
				return fetch(
					`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
						location
					)}`
				)
					.then((response) => response.json())
					.then((data) => {
						if (data && data.length > 0) {
							return {
								lat: data[0].lat,
								lon: data[0].lon,
							};
						} else {
							console.warn(
								'Nie znaleziono współrzędnych dla lokalizacji:',
								location
							);
							return null;
						}
					});
			}
		</script>
	</body>
</html>
